# Core

## 概要

`core` は **ocrjs 全体における最上位のドメイン層**であり、
OCR という概念を **最も抽象的かつ表面的な意味論のレベル**で定義する層です。

同時に `core` は、ocrjs 全体の中で **最も安定し、最も変更されにくい層**でもあります。

ここでは、OCR が

- 何であるか
- どのような入力を受け
- どのような結果を返し
- どのようなライフサイクルを持つか

といった **不変の世界観（契約）**のみを扱います。

`core` は **実行方法・実行環境・モデル形式・インフラ構成**を一切知りません。

大規模なユースケースを提供するものだと、考えると良いでしょう。

---

## Core の責務

`core` が担う責務は、次の 3 点に限定されます。

### 1. ドメイン概念の定義

OCR における基本的な概念を定義します。

- OCR インスタンスとは何か
- OCR の入力とは何か
- OCR の出力とは何か
- OCR の実行結果として保証される情報は何か

これらは **実装に依存しない抽象的な型・インターフェース**として表現されます。

---

### 2. ライフサイクルと状態の契約

OCR は「一度生成され、何度も実行され、最終的に破棄される」  
**状態を持つ存在**です。

`core` は、以下のようなライフサイクル上の契約を定義します。

- OCR インスタンスは `run` 可能である
- OCR インスタンスは `dispose` により明示的に破棄される
- 破棄後の OCR インスタンスは再利用できない
- OCR インスタンスは未初期化状態で `run` できない

---

### 3. 不変条件（Invariant）の保証

`core` は、OCR というドメインにおいて  
**常に守られるべきルール**を定義します。

例：

- 未初期化状態での実行は禁止される
- 破棄済みインスタンスへのアクセスは禁止される
- OCR の実行結果は、定義された出力構造に必ず従う

これらは例外や型によって明示され、  
実装依存の曖昧な挙動を排除します。

---

## Core が持たないもの（重要）

`core` は、次の要素を **一切含みません**。

- モデルのロード方法
- onnx / paddle / openocr などの実行基盤
- 実行環境（Node / Web / Bun / Deno）
- 前処理・後処理の具体的な実装
- 設定ファイル（yml / json）の解釈
- パフォーマンス最適化や量子化判断
- 計算のロジック

これらはすべて **実装レイヤ（engine / infra / runtime）の責務**です。

---

## レイヤ間の関係

`core` は **他のすべてのレイヤから参照される基盤**ですが、依存性逆転の原則により、**他のレイヤに依存しません**。

```text
core
 ↑
infra-contract
 ↑
engine
 ↑
runtime-*
```

この依存方向を守ることで、  
ocrjs は実行基盤や環境が変わっても安定して拡張できます。

---

## 設計思想

`core` の設計は、以下の思想に基づいています。

- **退屈であることを良しとする**
- 実装の自由度を最大化するため、制約は最小限にする
- 変化しないものだけを定義する
- 実行の詳細を一切想定しない

`core` が長期間変更されないこと自体が、  
ocrjs 全体の安定性を保証します。

---

## まとめ

- `core` は **ocrjs の世界観と契約を定義する層**
- 実装・実行・最適化の責務は持たない
- すべての上位レイヤは `core` の契約に従う
- `core` は変更されにくいほど良い設計である
